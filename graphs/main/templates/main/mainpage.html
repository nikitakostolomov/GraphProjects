{% extends 'main/wrapper.html' %}
{% load static %}
{% block title %} Сегментация {% endblock %} 
{% block content %}

<div class="main"> 
    <div class="download-container"> 
        <form method="post" enctype="multipart/form-data" action="/"> 
            {% csrf_token %}
            <label for="id_image">Изображение:</label> <input type="file"  class="inline" name="image" accept="image/*" required id="id_image">
            <label for="id_image_verify">Изображение для проверки:</label> <input type="file"  class="inline" name="image_verify" accept="image/*" required id="id_image_verify">
            <button type="submit" class ="my-button inline"> Загрузить изображение </button>
        </form> 
    </div>

    <div class="manage-container"> 
        <!-- Если изображение уже загружено -->
        {% if is_download_img %}
        <form action="segmentation" method="post" class="inline">
            {% csrf_token %}
            <input class="hidden" id="object_pixels" name="object_pixels" value="">
            <input class="hidden" id="background_pixels" name="background_pixels" value="">
            <input type="submit"  onclick=normalization() class ="my-button" value="Запуск алгоритма">
        </form>
            <input type="button" class ="my-button inline" value ="Сброс" onclick=dropping()>
        <label class="switch inline">
            <input id ="type_of_pixels" class="inline" type="checkbox" onclick=changespan()> 
            <span class="slider round"></span>
        </label>
        <span id="type_of_choose">
            Выбор пикселей объекта
        </span>
    </div>
    
    <div class="screen">
            <canvas id=canvas width=600vmax height=600vmax></canvas>
            <canvas id=pixel_canvas></canvas>
            <canvas id=result_canvas></canvas>
    </div>
</div>

    <script>
        var canvas=document.getElementById("canvas");
        var pixel_canvas=document.getElementById("pixel_canvas");
        var context=canvas.getContext("2d");
        var pixel_context=pixel_canvas.getContext("2d");
        var image=new Image();
        image.src="/media/{{ img }}";
        image.crossOrigin = 'anonymous';
        var width;
        var height;
        var radius=7;
        var pushable;
        var object_pixels=[]; 
        var background_pixels=[];
        var is_background;
        var result = document.getElementById("result_canvas");
        var result_context = result.getContext("2d");
        var ratio;
        const red='rgba(255,0,0,0.3)';
        const green='rgba(0,255,0,0.3)';
        const screenWidth = window.screen.width
        const screenHeight = window.screen.height
        
        function circle(x,y,radius,color){
            pixel_context.fillStyle = color;
            pixel_context.beginPath();
            pixel_context.arc(x,y, radius, 0, 2 * Math.PI);
            pixel_context.closePath();
            pixel_context.fill();   
        }
        function changespan(){
            if (document.getElementById('type_of_pixels').checked) document.getElementById("type_of_choose").textContent='Выбор пикселей фона';
            else document.getElementById("type_of_choose").textContent='Выбор пикселей объекта';
        };
        // Когда картинка загрузилась, масштабируем её под канвас
        image.onload=function(){
            var hRatio = canvas.width  / image.width;
            var vRatio =  canvas.height / image.height;
            ratio  = Math.min ( hRatio, vRatio );
            width = image.width*ratio;
            height = image.height*ratio;
            context.clearRect(0,0,canvas.width, canvas.height);
            canvas.width = width;
            canvas.height = height;
            pixel_canvas.width = width;
            pixel_canvas.height = height; 
            context.drawImage(image, 0,0, width, height); 

            // Окно результата
            if ('{{ result_img }}'== 'media/imagesresult/imgresult.jpeg'){
                var image_result=new Image();
                image_result.src='{{ result_img }}';
                image_result.onload=function(){    
                    result_context.drawImage(image_result, 0,0, width, height); 
                    result_context.fill();
                }
            }
            result.width = width;
            result.height = height;
        } 

             
        // При нажатии на холст рисуем кружочки
        pixel_canvas.onclick=function(e){
            if (document.getElementById('type_of_pixels').checked){
                choose_pixel(e,background_pixels,green);            
               document.getElementById('background_pixels').value=background_pixels;
            }
            else {
                choose_pixel(e,object_pixels,red);
                document.getElementById('object_pixels').value=object_pixels;
            }
        }

        function choose_pixel(e,pixels,color){
            pushable = true;
            // для совместимости с другими браузерами
            if(e.offsetX==undefined) {
                var x = e.pageX-$(canvas).offset().left;
                var y = Math.round(e.pageY-$(canvas).offset().top);
            } 
            else {
                var x = e.offsetX;
                var y = e.offsetY;
            }
            //Если нажал внутрь существующего кружочка, удаляем его
            for (let i = 0; i < pixels.length ; i++){
                if (Math.sqrt(Math.pow(x-pixels[i][0]*ratio, 2)+Math.pow(y-pixels[i][1]*ratio, 2))<=radius){
                    pixel_context.clearRect(0,0,canvas.width, canvas.height);
                    pixels[i] = pixels[pixels.length - 1];
                    pixels.length--;
                    i--;
                    pushable = false;
                }
            };
            if(pushable){
                pixels.push([Math.round(x/ratio),Math.round(y/ratio)]);
                circle(x,y,radius,color);
            }
            else {
                for (let i = 0; i < object_pixels.length ; i++){
                    circle(ratio*object_pixels[i][0],ratio*object_pixels[i][1],radius,red);
                };  
                for (let i = 0; i < background_pixels.length ; i++){
                    circle(ratio*background_pixels[i][0],ratio*background_pixels[i][1],radius,green);
                };  

            }   
        };
        function dropping(){
            pixel_context.clearRect(0,0,canvas.width, canvas.height);
            document.getElementById('object_pixels').value=' ';
            document.getElementById('background_pixels').value=' ';
            object_pixels=[]; 
            background_pixels=[];
        }
    </script>

{% endif %}
{% endblock %}
